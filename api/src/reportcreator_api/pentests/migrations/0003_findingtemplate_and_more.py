# Generated by Django 4.0.4 on 2022-07-20 17:08

import uuid

import django.core.serializers.json
from django.db import migrations, models

import reportcreator_api.pentests.fielddefinition.predefined_fields
import reportcreator_api.pentests.fielddefinition.validators
import reportcreator_api.utils.fielddefinition.mixins
import reportcreator_api.utils.fielddefinition.types
import reportcreator_api.utils.fielddefinition.utils
import reportcreator_api.utils.models
from reportcreator_api.pentests.fielddefinition.predefined_fields import (
    FINDING_FIELDS_CORE,
    FINDING_FIELDS_PREDEFINED,
    REPORT_FIELDS_CORE,
    REPORT_FIELDS_PREDEFINED,
)
from reportcreator_api.utils.fielddefinition.types import FieldOrigin


def set_field_origin(definition: dict, core_fields=None, predefined_fields=None):
    out = {}
    for k, d in definition.items():
        d = d.copy()
        out[k] = d

        d.pop('static', None)
        if core_fields and k in core_fields:
            d['origin'] = FieldOrigin.CORE.value
        elif predefined_fields and k in predefined_fields:
            d['origin'] = FieldOrigin.CUSTOM.value
        else:
            d['origin'] = FieldOrigin.CUSTOM

        if d.get('type') == 'object':
            d['properties'] = set_field_origin(d.get('properties', {}))
        elif d.get('type') == 'list':
            d['items'] = set_field_origin({'items': d.get('items', {})})['items']
    return out


def migrate_field_definition_static_to_origin(apps, schema_editor):
    ProjectType = apps.get_model('pentests', 'projecttype')
    for pt in ProjectType.objects.all():
        # Load and serialize definition to update format to current structure
        pt.finding_fields = set_field_origin(pt.finding_fields, core_fields=FINDING_FIELDS_CORE, predefined_fields=FINDING_FIELDS_PREDEFINED)
        pt.report_fields = set_field_origin(pt.report_fields, core_fields=REPORT_FIELDS_CORE, predefined_fields=REPORT_FIELDS_PREDEFINED)
        pt.save()


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0002_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='FindingTemplate',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created', models.DateTimeField(auto_now_add=True)),
                ('updated', models.DateTimeField(auto_now=True)),
                ('usage_count', models.PositiveIntegerField(db_index=True, default=0)),
                ('tags', django.contrib.postgres.fields.ArrayField(base_field=models.CharField(max_length=255), db_index=True, default=list, size=None)),
                ('title', models.TextField(db_index=True, default='')),
                ('cvss', models.CharField(default='n/a', max_length=50)),
                ('custom_fields', models.JSONField(default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder)),
            ],
            options={
                'ordering': ['-usage_count', '-created'],
            },
            bases=(reportcreator_api.utils.fielddefinition.mixins.CustomFieldsMixin, reportcreator_api.utils.models.ModelDiffMixin, models.Model),
        ),
        migrations.AlterField(
            model_name='projecttype',
            name='finding_fields',
            field=models.JSONField(default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder),
        ),
        migrations.AlterField(
            model_name='projecttype',
            name='report_fields',
            field=models.JSONField(default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder),
        ),
        migrations.RunPython(code=migrate_field_definition_static_to_origin, reverse_code=migrations.RunPython.noop),
        migrations.AlterField(
            model_name='pentestfinding',
            name='risk_level',
            field=models.CharField(choices=[('none', 'None'), ('low', 'Low'), ('medium', 'Medium'), ('high', 'High'), ('critical', 'Critical')], db_index=True, default='none', max_length=10),
        ),
        migrations.AlterField(
            model_name='pentestfinding',
            name='risk_score',
            field=models.FloatField(db_index=True, default=0.0),
        ),
        migrations.AlterField(
            model_name='pentestfinding',
            name='title',
            field=models.TextField(db_index=True, default=''),
        ),
        migrations.AlterField(
            model_name='pentestproject',
            name='name',
            field=models.CharField(db_index=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='pentestreport',
            name='title',
            field=models.TextField(db_index=True, default=''),
        ),
        migrations.AlterField(
            model_name='projecttype',
            name='name',
            field=models.CharField(db_index=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='uploadedasset',
            name='name',
            field=models.CharField(db_index=True, max_length=255),
        ),
    ]
