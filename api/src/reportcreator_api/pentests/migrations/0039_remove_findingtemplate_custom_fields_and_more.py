# Generated by Django 4.2.3 on 2023-07-04 08:39

import uuid

import django.core.serializers.json
import django.db.models.deletion
from django.db import migrations, models

import reportcreator_api.pentests.models.common
import reportcreator_api.utils.crypto.fields
import reportcreator_api.utils.fielddefinition.mixins
import reportcreator_api.utils.models
from reportcreator_api.utils.migrations import AlterModelBaseOperation
from reportcreator_api.utils.utils import omit_keys


def migrate_template_translations(apps, schema_editor):
    FindingTemplate = apps.get_model('pentests', 'FindingTemplate')
    FindingTemplateTranslation = apps.get_model('pentests', 'FindingTemplateTranslation')

    for template in FindingTemplate.objects.iterator():
        template.main_translation = FindingTemplateTranslation.objects.create(
            template=template,
            language=template.language,
            status=template.status,
            title=template.title,
            custom_fields=template.custom_fields | {'cvss': template.cvss},
            risk_score=template.risk_score,
            risk_level=template.risk_level,
        )
        template.save()


def reverse_migrate_template_translations(apps, schema_editor):
    FindingTemplate = apps.get_model('pentests', 'FindingTemplate')

    for template in FindingTemplate.objects.iterator():
        template.language = template.main_translation.language
        template.status = template.main_translation.status
        template.title = template.main_translation.title
        template.cvss = template.main_translation.data.get('cvss', 'n/a')
        template.risk_score = template.main_translation.risk_score
        template.risk_level = template.main_translation.risk_level
        template.custom_fields = omit_keys(template.main_translation.custom_fields, ['cvss'])
        template.save()


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0038_uploadedusernotebookfile'),
    ]

    operations = [
        migrations.CreateModel(
            name='FindingTemplateTranslation',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created', models.DateTimeField(default=reportcreator_api.utils.models.now, editable=False)),
                ('updated', models.DateTimeField(auto_now=True)),
                ('language', models.CharField(choices=[('en-US', 'English'), ('de-DE', 'German'), ('es-ES', 'Spanish'), ('fr-FR', 'French'), ('pt-PT', 'Portuguese'), ('it-IT', 'Italian'), ('nl-NL', 'Dutch'), ('da-DK', 'Danish'), ('pl-PL', 'Polish'), ('uk-UA', 'Ukrainian'), ('ro-RO', 'Romanian'), ('sk-SK', 'Slovak'), ('sl-SI', 'Slovenian'), ('el-GR', 'Greek'), ('sv-SE', 'Swedish'), ('sq-AL', 'Albanian'), ('bg-BG', 'Bulgarian'), ('hr-HR', 'Croatian'), ('et-EE', 'Estonian'), ('fi-FI', 'Finnish'), ('hu-HU', 'Hungarian'), ('lv-LV', 'Latvian'), ('lt-LT', 'Lithuanian'), ('mt-MT', 'Maltese'), ('nb-NO', 'Norwegian'), ('sr-SP', 'Serbian'), ('tr-TR', 'Turkish')], db_index=True, default=reportcreator_api.pentests.models.common.get_default_language, max_length=5)),
                ('custom_fields', models.JSONField(blank=True, default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder)),
                ('status', models.CharField(choices=[('in-progress', 'In progress'), ('ready-for-review', 'Ready for review'), ('needs-improvement', 'Needs improvement'), ('finished', 'Finished')], db_index=True, default='in-progress', max_length=20)),
                ('title', models.TextField(db_index=True, default='')),
                ('risk_score', models.FloatField(db_index=True, default=0.0)),
                ('risk_level', models.CharField(choices=[('info', 'Info'), ('low', 'Low'), ('medium', 'Medium'), ('high', 'High'), ('critical', 'Critical')], db_index=True, default='info', max_length=10)),
                ('template', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='translations', to='pentests.findingtemplate')),
            ],
            bases=(reportcreator_api.utils.models.ModelDiffMixin, models.Model),
        ),
        migrations.AddConstraint(
            model_name='findingtemplatetranslation',
            constraint=models.UniqueConstraint(deferrable=django.db.models.constraints.Deferrable['DEFERRED'], fields=('template', 'language'), name='unique_language_per_template'),
        ),
        migrations.AddField(
            model_name='findingtemplate',
            name='main_translation',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='pentests.findingtemplatetranslation'),
        ),
        migrations.RunPython(code=migrate_template_translations, reverse_code=reverse_migrate_template_translations),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='custom_fields',
        ),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='cvss',
        ),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='language',
        ),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='risk_level',
        ),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='risk_score',
        ),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='status',
        ),
        migrations.RemoveField(
            model_name='findingtemplate',
            name='title',
        ),
        AlterModelBaseOperation(
            name='findingtemplate',
            bases=(reportcreator_api.utils.models.ModelDiffMixin, models.Model),
            prev_bases=(reportcreator_api.utils.fielddefinition.mixins.CustomFieldsMixin, reportcreator_api.utils.models.ModelDiffMixin, models.Model),
        ),
        migrations.AlterField(
            model_name='pentestfinding',
            name='custom_fields',
            field=reportcreator_api.utils.crypto.fields.EncryptedField(base_field=models.JSONField(blank=True, default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder), editable=True),
        ),
        migrations.AlterField(
            model_name='pentestproject',
            name='custom_fields',
            field=reportcreator_api.utils.crypto.fields.EncryptedField(base_field=models.JSONField(blank=True, default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder), editable=True),
        ),
    ]
