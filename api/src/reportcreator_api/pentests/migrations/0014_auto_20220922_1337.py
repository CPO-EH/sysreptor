# Generated by Django 4.0.7 on 2022-09-22 13:37

from django.db import migrations

from reportcreator_api.utils.fielddefinition.types import (
    FieldDataType,
)


def field_definition_set_required(definition: dict):
    out = {}
    for k, d in definition.items():
        d = d.copy()
        out[k] = d

        if d.get('type') not in [FieldDataType.OBJECT.value, FieldDataType.BOOLEAN.value]:
            d['required'] = True

        if d.get('type') == FieldDataType.OBJECT.value:
            d['properties'] = field_definition_set_required(d.get('properties', {}))
        elif d.get('type') == FieldDataType.LIST.value:
            d['items'] = field_definition_set_required({'items': d.get('items', {})})['items']

    return out


def migrate_add_required_to_field_definitions(apps, schema_editor):
    ProjectType = apps.get_model('pentests', 'ProjectType')
    project_types = list(ProjectType.objects.all())
    for project_type in project_types:
        project_type.finding_fields = field_definition_set_required(project_type.finding_fields)
        project_type.report_fields = field_definition_set_required(project_type.report_fields)
    ProjectType.objects.bulk_update(project_types, fields=['finding_fields', 'report_fields'])


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0013_pentestfinding_template_and_more'),
    ]

    operations = [
        migrations.RunPython(code=migrate_add_required_to_field_definitions, reverse_code=migrations.RunPython.noop),
    ]
