# Generated by Django 5.0 on 2023-12-27 09:13

import itertools

from django.db import migrations, models

from sysreptor.pentests import cvss


def migrate_update_risk_score(apps, schema_editor):
    def get_field(tr, name):
        data = tr.template.main_translation.custom_fields | tr.custom_fields
        return data.get(name)

    FindingTemplateTranslation = apps.get_model('pentests', 'FindingTemplateTranslation')
    for translations in itertools.batched(FindingTemplateTranslation.objects.all().select_related('template__main_translation'), 1000):
        for tr in translations:
            cvss_vector = get_field(tr, 'cvss')
            severity = get_field(tr, 'severity')
            if cvss_vector:
                tr.risk_score = cvss.calculate_score(cvss_vector)
                tr.risk_level = cvss.level_from_score(tr.risk_score)
            elif severity:
                tr.risk_score = None
                tr.risk_level = severity
            else:
                tr.risk_score = None
                tr.risk_level = None
        FindingTemplateTranslation.objects.bulk_update(translations, ['risk_score', 'risk_level'])


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0048_history_title'),
    ]

    operations = [
        migrations.AlterField(
            model_name='findingtemplatetranslation',
            name='risk_level',
            field=models.CharField(choices=[('info', 'Info'), ('low', 'Low'), ('medium', 'Medium'), ('high', 'High'), ('critical', 'Critical')], db_index=True, max_length=10, null=True),
        ),
        migrations.AlterField(
            model_name='findingtemplatetranslation',
            name='risk_score',
            field=models.FloatField(db_index=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalfindingtemplatetranslation',
            name='risk_level',
            field=models.CharField(choices=[('info', 'Info'), ('low', 'Low'), ('medium', 'Medium'), ('high', 'High'), ('critical', 'Critical')], db_index=True, max_length=10, null=True),
        ),
        migrations.AlterField(
            model_name='historicalfindingtemplatetranslation',
            name='risk_score',
            field=models.FloatField(db_index=True, null=True),
        ),
        migrations.RunPython(code=migrate_update_risk_score, reverse_code=migrations.RunPython.noop),
    ]
