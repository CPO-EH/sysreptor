# Generated by Django 4.2.5 on 2023-09-11 13:54

from django.db import migrations, models
from django.test import override_settings

import sysreptor.utils.crypto.fields


def migrate_encrypt_history_change_reason(apps, schema_editor):
    models = [
        apps.get_model('pentests', 'HistoricalFindingTemplate'),
        apps.get_model('pentests', 'HistoricalFindingTemplateTranslation'),
        apps.get_model('pentests', 'HistoricalPentestFinding'),
        apps.get_model('pentests', 'HistoricalPentestProject'),
        apps.get_model('pentests', 'HistoricalProjectMemberInfo'),
        apps.get_model('pentests', 'HistoricalProjectNotebookPage'),
        apps.get_model('pentests', 'HistoricalProjectType'),
        apps.get_model('pentests', 'HistoricalReportSection'),
        apps.get_model('pentests', 'HistoricalUploadedAsset'),
        apps.get_model('pentests', 'HistoricalUploadedImage'),
        apps.get_model('pentests', 'HistoricalUploadedProjectFile'),
        apps.get_model('pentests', 'HistoricalUploadedTemplateImage'),
    ]

    with override_settings(ENCRYPTION_PLAINTEXT_FALLBACK=True):
        for model in models:
            model.objects.bulk_update(model.objects.all().iterator(), ['history_change_reason'])


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0045_history'),
    ]

    operations = [
        migrations.AlterField(
            model_name='historicalfindingtemplate',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalfindingtemplatetranslation',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalpentestfinding',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalpentestproject',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalprojectmemberinfo',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalprojectnotebookpage',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalprojecttype',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicalreportsection',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicaluploadedasset',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicaluploadedimage',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicaluploadedprojectfile',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.AlterField(
            model_name='historicaluploadedtemplateimage',
            name='history_change_reason',
            field=sysreptor.utils.crypto.fields.EncryptedField(base_field=models.TextField(blank=True, null=True), editable=True, null=True),
        ),
        migrations.RunPython(code=migrate_encrypt_history_change_reason, reverse_code=migrate_encrypt_history_change_reason),
    ]
