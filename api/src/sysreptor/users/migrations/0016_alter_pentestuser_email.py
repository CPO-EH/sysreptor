# Generated by Django 5.1.7 on 2025-03-26 09:18

from django.db import migrations, models

from sysreptor.utils.models import SubqueryCount


def migrate_user_email_unique(apps, schema_editor):
    PentestUser = apps.get_model('users', 'PentestUser')
    # Convert blank emails to None
    PentestUser.objects.filter(email='').update(email=None)
    # Remove duplicate emails
    PentestUser.objects \
        .filter(email__isnull=False) \
        .values('email') \
        .annotate(email_count=SubqueryCount(PentestUser.objects.filter(email=models.OuterRef('email')))) \
        .filter(email_count__gte=2) \
        .update(email=None)


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0015_pentestuser_color'),
    ]

    operations = [
        migrations.RunPython(code=migrate_user_email_unique, reverse_code=migrations.RunPython.noop),
        migrations.AlterField(
            model_name='pentestuser',
            name='email',
            field=models.EmailField(blank=True, max_length=254, null=True, unique=True, verbose_name='Email address'),
        ),
        migrations.AlterModelOptions(
            name='pentestuser',
            options={'ordering': ['-created'], 'verbose_name': 'user', 'verbose_name_plural': 'users'},
        ),
    ]
